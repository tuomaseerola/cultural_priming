---
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# README

These are analysis operations and data for the study titled "Valenced Priming with Acquired Affective Concepts in Music: Automatic Reactions to Common Tonal Chords" by Imre Lahdelma and [Tuomas Eerola](https://tuomaseerola.github.io/) in the journal of _Music Perception_. Read this document at the [documentation site](https://tuomaseerola.github.io/cultural_priming/).

# Sample size

Here is the link to the scripts and functions for [planning](https://tuomaseerola.github.io/cultural_priming/planning.html) the sample size for one sub-experiment.

# Data analysis

Four sub-experiments, all collected separately using psytoolkit. Original data in zipped folder `raw_data.zip` and requires `compile_data.R` script. For convenience we rely on the exported CSV files per experiment. 

## Load data

```{r load_data, warning = FALSE, message = FALSE}
rm(list = ls())
library(ggplot2)
library(see)
library(dplyr)
library(ggdist)
library(tidybayes)
options(dplyr.summarise.inform = FALSE)

#### 2. Compile or load data ------------------------------------------
#source('compile_data.R')          # simply reading in the raw data and aggregating the background
source('load_data.R')             # reading in the data that has been filtered (exgaussian, practice trials)
```

## Describe participants

```{r describe_data, warning = FALSE, message = FALSE}
source('describe_participants.R')
d1 <- describe_participants(MIN)
d2 <- describe_participants(AUG)
d3 <- describe_participants(DIM)
d4 <- describe_participants(SUS)

source('background_across_substudies.R') # Compare backgrounds across the sub-experiments
```

# Describe and Visualise data

First show the means across conditions (table).

```{r means, fig.width=10.5,fig.height=7,warning=FALSE,message=FALSE,results='asis'}
source('table_of_means.R')             # create table of means
```


```{r plot1, fig.width=10.5,fig.height=7,warning=FALSE,message=FALSE, eval=FALSE,echo=FALSE}
source('visualise.R')             # as to take in the block information

fig1 <- visualise(data = MIN,titletext='Major-Minor') 
fig2 <- visualise(data = AUG,titletext='Major-Augmented') 
fig3 <- visualise(data = DIM,titletext='Major-Diminished') 
fig4 <- visualise(data = SUS,titletext='Major-Suspended 4') 

G1<-see::plots(fig1[[1]], fig2[[1]], fig3[[1]], fig4[[1]], n_columns = 2, tags = FALSE,guides = "collect")

G2<-see::plots(fig1[[2]], fig2[[2]], fig3[[2]], fig4[[2]], n_columns = 2, tags = FALSE,guides = "collect")

print(G1)
print(G2)
```


```{r save_figs, eval = FALSE,echo=FALSE}
ggsave(filename = 'means.png',plot = G1, device = 'png',dpi = 300, width = 9.5, height = 7)
ggsave(filename = 'mean_and_raw_values.png',plot = G2, device = 'png',dpi = 300, width = 10.5, height = 7)
```

# Bayesian Analysis

```{r analysis1, eval = FALSE}
source('calculate_bayes.R')   # function to calculate

# One sub-experiment takes about 20 mins to analyse, save results
b1 <- calculate_bayes(SUS)
save(b1,file = 'data/SUS_bayesR1.RData')
b1 <- calculate_bayes(MIN)
save(b1,file = 'data/MIN_bayesR1.RData')
b1 <- calculate_bayes(AUG)
save(b1,file = 'data/AUG_bayesR1.RData')
b1 <- calculate_bayes(DIM) # 18 min
save(b1,file = 'data/DIM_bayesR1.RData')
```

## Describe models

Check the model performance and the group-level effects (disabled for now as the reporting is long).

```{r models, eval=FALSE}
load('data/MIN_bayesR1.RData')
summary(b1)
brms::ranef(b1)

load('data/AUG_bayesR1.RData')
summary(b1)
brms::ranef(b1)

load('data/DIM_bayesR1.RData')
summary(b1)
brms::ranef(b1)

load('data/SUS_bayesR1.RData')
summary(b1)
brms::ranef(b1)

```


## Report Bayesian evidence

Test directional hypothesis about congruence.

```{r analysis2, eval=TRUE,warning=FALSE,message=FALSE}
library(brms)

load('data/MIN_bayesR1.RData')
hyp_MIN <- brms::hypothesis(b1,"CongruenceN > 0",seed=1234,scope="standard",robust=TRUE)
load('data/AUG_bayesR1.RData')
hyp_AUG <- brms::hypothesis(b1,"CongruenceN > 0",seed=1234,scope="standard",robust=TRUE)
load('data/DIM_bayesR1.RData')
hyp_DIM <- brms::hypothesis(b1,"CongruenceN > 0",seed=1234,scope="standard",robust=TRUE)
load('data/SUS_bayesR1.RData')
hyp_SUS <- brms::hypothesis(b1,"CongruenceN > 0",seed=1234,scope="standard",robust=TRUE)

```

## Bayesian analysis summary table

Draw analysis results together as a table.

```{r table,results='asis'}
table2 <- rbind(hyp_MIN$hypothesis,hyp_AUG$hypothesis,hyp_DIM$hypothesis, hyp_SUS$hypothesis)
rownames(table2)<-c("Major-Minor","Major-Augmentd","Major-Diminished","Major-Suspended 4")
table2$Hypothesis<-'Congruence > 0'
knitr::kable(table2,digits = 4,caption='Summary of the analyses of each sub-experiment.')
```



## Mean marginal effects in milliseconds

```{r figuremeans,fig.width = 9.5,fig.height = 7,warning=FALSE, message=FALSE}
library(emmeans)
load('data/MIN_bayesR1.RData')

draws <- b1 %>% 
  emmeans(~ CongruenceN,epred = TRUE) %>%
  contrast(method = "revpairwise") %>%
  gather_emmeans_draws()

draws %>% median_hdi()

g1 <- ggplot(draws, aes(x = .value)) +
  stat_halfeye(fill = 'grey70') +
  labs(x = "Marginal effect of Congruence (ms)", y = "Density",title = 'Major-Minor') +
  see::theme_modern() +
  theme(legend.position = "bottom")+
  scale_x_continuous(limits = c(-3,12),breaks = seq(-3,12,by=3))+
  theme(text = element_text(size = 16,  family = "Palatino")) +
  theme(plot.title = element_text(hjust = 0.5))

load('data/AUG_bayesR1.RData')

draws <- b1 %>% 
  emmeans(~ CongruenceN,epred = TRUE) %>%
  contrast(method = "revpairwise") %>%
  gather_emmeans_draws()

draws %>% median_hdi()

g2 <- ggplot(draws, aes(x = .value)) +
  stat_halfeye(fill = 'grey70') +
  labs(x = "Marginal effect of Congruence (ms)", y = "Density",title = 'Major-Augmented') +
  see::theme_modern() +
  theme(legend.position = "bottom")+
  scale_x_continuous(limits = c(-3,12),breaks = seq(-3,12,by=3))+
  theme(text = element_text(size = 16,  family = "Palatino")) +
  theme(plot.title = element_text(hjust = 0.5))

load('data/DIM_bayesR1.RData')

draws <- b1 %>% 
  emmeans(~ CongruenceN,epred = TRUE) %>%
  contrast(method = "revpairwise") %>%
  gather_emmeans_draws()

draws %>% median_hdi()

g3 <- ggplot(draws, aes(x = .value)) +
  stat_halfeye(fill = 'grey70') +
  labs(x = "Marginal effect of Congruence (ms)", y = "Density",title = 'Major-Diminished') +
  see::theme_modern() +
  theme(legend.position = "bottom")+
  scale_x_continuous(limits = c(-3,12),breaks = seq(-3,12,by=3))+
  theme(text = element_text(size = 16,  family = "Palatino")) +
  theme(plot.title = element_text(hjust = 0.5))

load('data/SUS_bayesR1.RData')

draws <- b1 %>% 
  emmeans(~ CongruenceN,epred = TRUE) %>%
  contrast(method = "revpairwise") %>%
  gather_emmeans_draws()

draws %>% median_hdi()

g4 <- ggplot(draws, aes(x = .value)) +
  stat_halfeye(fill = 'grey70') +
  labs(x = "Marginal effect of Congruence (ms)", y = "Density",title = 'Major-Suspended 4') +
  see::theme_modern() +
  theme(legend.position = "bottom")+
  scale_x_continuous(limits = c(-3,12),breaks = seq(-3,12,by=3))+
  theme(text = element_text(size = 16,  family = "Palatino")) +
  theme(plot.title = element_text(hjust = 0.5))


G3 <- see::plots(g1, g2, g3, g4, n_columns = 2, tags = FALSE,guides = "collect")
G3
```

### Save Figure 1

```{r, eval = FALSE}
ggsave(filename = 'marginal_effects.png',plot = G3, device = 'png',dpi = 300,width = 9.5,height = 7)
```


## Plot posterior plots

```{r figure2, message = FALSE, warning = FALSE,fig.width=9.5,fig.height=7}
library(extrafont)
library(latex2exp)

posterior_MIN <- hyp_MIN$samples
result_MIN <- bayestestR::hdi(posterior_MIN, ci = c(0.95))
p1 <- plot(result_MIN)+
  scale_fill_brewer(type = 'seq',palette = 'Greys',direction = -1)+
  see::theme_modern()+
  scale_x_continuous(limits = c(-0.005,0.015))+
  labs(title = TeX(r"(Major-Minor (Congruence $\theta$))"))+ 
   theme(text=element_text(size=16,  family="Palatino"))+
   theme(plot.title = element_text(hjust = 0.5))

posterior_AUG <- hyp_AUG$samples
result_AUG <- bayestestR::hdi(posterior_AUG, ci = c(0.95))
p2 <- plot(result_AUG)+
  scale_fill_brewer(type = 'seq',palette = 'Greys',direction = -1)+
  see::theme_modern()+
  scale_x_continuous(limits = c(-0.005,0.015))+
  labs(title = TeX(r"(Major-Augmented (Congruence $\theta$))"))+ 
   theme(text=element_text(size=16,  family="Palatino"))+
   theme(plot.title = element_text(hjust = 0.5))

posterior_DIM <- hyp_DIM$samples
result_DIM <- bayestestR::hdi(posterior_DIM, ci = c(0.95))
p3 <- plot(result_DIM)+
  scale_fill_brewer(type = 'seq',palette = 'Greys',direction = -1)+
  see::theme_modern()+
  scale_x_continuous(limits = c(-0.005,0.015))+
  labs(title = TeX(r"(Major-Diminished (Congruence $\theta$))"))+ 
   theme(text=element_text(size=16,  family="Palatino"))+
   theme(plot.title = element_text(hjust = 0.5))

posterior_SUS <- hyp_SUS$samples
result_SUS <- bayestestR::hdi(posterior_SUS, ci = c(0.95))
p4 <- plot(result_SUS)+
  scale_fill_brewer(type = 'seq',palette = 'Greys',direction = -1)+
  see::theme_modern()+
  scale_x_continuous(limits = c(-0.005,0.015))+
  labs(title = TeX(r"(Major-Suspended 4 (Congruence $\theta$))"))+ 
   theme(text=element_text(size=16,  family="Palatino"))+
   theme(plot.title = element_text(hjust = 0.5))

G<-see::plots(p1, p2, p3, p4, n_columns = 2, tags = FALSE,guides = "collect")
print(G)
```

### Save Figure 2

```{r, eval = FALSE}
ggsave(filename = 'thetas.png',plot = G, device = 'png',dpi = 300,width = 9.5,height = 7)
```


# Compare the evidence between the sub-experiments 

Does _Major--Diminished_ chord pair provide significantly stronger evidence than _Major--Augmented_ pair using the posterior distributions? How large is the difference?

## Mean difference between the sub-experiments

```{r comparemodels, warning = FALSE,message=FALSE}
library(bayestestR)
posteriors <-
  data.frame(DIM = posterior_DIM$H1, AUG = posterior_AUG$H1) # join the posteriors of interest

# calculate the mean difference

posteriors = posteriors %>%
  mutate(mu_diff = DIM - AUG) # calculate difference

ggplot(posteriors, aes(mu_diff)) +
  geom_histogram(aes(y = ..density..),
                 color = "grey50",
                 fill = "white") +
  geom_density(linewidth = 1, color = "black") +
  xlab("Difference in population mean DIM - AUG") +
  labs(x = "Difference in population mean DIM - AUG", y='Density', title = "Posterior Distribution") +
  see::theme_modern() +
  theme(text = element_text(size = 16,  family = "Palatino")) +
  theme(plot.title = element_text(hjust = 0.5))

quantile(posteriors$mu_diff, c(0.01, 0.10, 0.25, 0.50, 0.75, 0.90, 0.99))

sum(posteriors$mu_diff > 0) / length(posteriors$mu_diff) # 0.7937

d <- bayestestR::ci(posteriors$mu_diff,ci = 0.95)
d$CI_low
d$CI_high

```

There is a posterior probability of about 79 percent that the congruence for DIM is greater than the mean congruence for AUG.

# Frequentist analysis

For a comparison (and for a comfort), let's run linear mixed model (LMM) with the same parameters (random factors) as defined in the Bayesian model.

```{r lmmfunction}
lmer_analysis <- function(data = NULL) {
  # lmer_analysis.R
  
  df <- data
  
  library(lme4)
  library(lmerTest)
  library(emmeans)
  library(nlme)
  options(contrasts = c("contr.sum", "contr.poly"))
  
  m0_lmm <-
    lmer(log(RT) ~ Congruence + (1 + Congruence |
                                   Id) + (1 | RandTransp) + (1 | Word),
         data = df)
  return <- summary(m0_lmm)
}

```

Run the model for each sub-experiment and summarise results.

```{r lmm, results = 'asis', message = FALSE, warning = FALSE}

lmm1 <- lmer_analysis(data = MIN) # 0.0854
lmm2 <- lmer_analysis(data = AUG) # 0.0273
lmm3 <- lmer_analysis(data = DIM) # 0.0007
lmm4 <- lmer_analysis(data = SUS) # 0.141

s1 <- summary(lmm1)
s2 <- summary(lmm2)
s3 <- summary(lmm3)
s4 <- summary(lmm4)

S <-
  rbind(s1$coefficients[2, ],
        s2$coefficients[2, ],
        s3$coefficients[2, ],
        s4$coefficients[2, ])
rownames(S) <-
  c('Major-Minor',
    'Major-Augmented',
    'Major-Diminished',
    'Major-Suspended 4')
knitr::kable(S, digits = 4)

```

